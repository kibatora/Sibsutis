version: '3.8'

services:
  # Сервис 1: База данных PostgreSQL
  db:
    image: postgres:14-alpine  # Используем официальный, легкий образ PostgreSQL 14
    container_name: base_db
    restart: always
    environment:
      - POSTGRES_USER=myuser
      - POSTGRES_PASSWORD=mypassword
      - POSTGRES_DB=base_db
    volumes:
      # Эта строка берет наш init.sql и выполняет его при первом запуске контейнера
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
      # Эта строка сохраняет данные БД на твоем диске, чтобы они не пропали при перезапуске
      - postgres_data:/var/lib/postgresql/data/
    ports:
      # Пробрасываем порт, чтобы можно было подключиться к БД с твоего компьютера (например, через DBeaver)
      - "5433:5432"
    networks:
      - base_network

# Сервис 2: Бэкенд на Python (API-сервер)
  backend:
    container_name: base_backend
    build:
      context: ./backend
    restart: always
    ports:
      - "8001:8000"
    depends_on:
      - db
    environment:
      - DB_HOST=db
      - DB_NAME=base_db
      - DB_USER=myuser
      - DB_PASSWORD=mypassword
    networks:
      - base_network

# Сервис 3: Симулятор игрового процесса
  simulator:
    container_name: base_simulator
    build:
      context: ./simulator
    command: python3 main.py
    restart: on-failure
    depends_on:
      - backend
    networks:
      - base_network

# Определяем общую сеть для всех контейнеров
networks:
  base_network:
    driver: bridge

# Определяем том для хранения данных БД
volumes:
  postgres_data: